"use strict";(self.webpackChunksleact_ts_front=self.webpackChunksleact_ts_front||[]).push([[251],{54251:function(e,t,n){n.r(t),n.d(t,{default:function(){return S}});var r=n(67294),l=n(66482),o=(0,l.Z)("div",{target:"e13mz3kp1"})({name:"1a0r0eh",styles:"display:flex;flex-wrap:wrap;height:calc(100vh - 38px);flex-flow:column;position:relative"}),a=(0,l.Z)("header",{target:"e13mz3kp0"})({name:"1c17pcy",styles:"height:64px;display:flex;width:100%;--saf-0:rgba(var(--sk_foreground_low, 29, 28, 29), 0.13);box-shadow:0 1px 0 var(--saf-0);padding:20px 16px 20px 20px;font-weight:bold;align-items:center;& img{margin-right:5px;}"}),c=n(66182),i=n.n(c),u=n(8100),s=n(83564),f=n(5977),d=n(80509),m=n(17354),p=n(38678),h=n(9669),v=n.n(h),g=n(18667),y=n(44593),b=n(32951),w=n(39249);function k(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,l,o=[],a=!0,c=!1;try{for(n=n.call(e);!(a=(r=n.next()).done)&&(o.push(r.value),!t||o.length!==t);a=!0);}catch(e){c=!0,l=e}finally{try{a||null==n.return||n.return()}finally{if(c)throw l}}return o}}(e,t)||function(e,t){if(e){if("string"==typeof e)return x(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?x(e,t):void 0}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function x(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var S=function(){var e,t,n=(0,r.useRef)(null),l=(0,f.UO)(),c=l.workspace,h=l.id,x=(0,u.ZP)("/api/users",s.Z),S=x.data,Z=(x.error,x.mutate,(0,u.ZP)("/api/workspaces/".concat(c,"/users/").concat(h),s.Z).data),E=(0,y.ZP)((function(e){return"/api/workspaces/".concat(c,"/dms/").concat(h,"/chats?perPage=20&page=").concat(e+1)}),s.Z),C=E.data,A=E.mutate,T=E.setSize,I=k((0,b.Z)(c),1)[0],_=0===(null==C||null===(e=C[0])||void 0===e?void 0:e.length),B=_||C&&(null===(t=C[C.length-1])||void 0===t?void 0:t.length)<20||!1,R=k((0,p.Z)(""),3),z=R[0],O=R[1],P=R[2],j=(0,r.useCallback)((function(e){if(e.preventDefault(),null!=z&&z.trim()&&C){var t=z;A((function(e){var n;return null==e||e[0].unshift({id:((null===(n=C[0][0])||void 0===n?void 0:n.id)||0)+1,content:t,SenderId:S.id,Sender:S,ReceiverId:Z.id,Receiver:Z,createdAt:new Date}),e}),!1).then((function(){var e;P(""),null===(e=n.current)||void 0===e||e.scrollToBottom()})),v().post("/api/workspaces/".concat(c,"/dms/").concat(h,"/chats"),{content:z}).then((function(){A()})).catch(console.error)}}),[z,C,S,Z,c,h]),D=(0,r.useCallback)((function(e){e.SenderId===Number(h)&&S.id!==Number(h)&&A((function(t){return null==t||t[0].unshift(e),t}),!1).then((function(){var e;n.current&&(n.current.getScrollHeight()<n.current.getClientHeight()+n.current.getScrollTop()+150?(console.log("scrollToBottom!",null===(e=n.current)||void 0===e?void 0:e.getValues()),setTimeout((function(){var e;null===(e=n.current)||void 0===e||e.scrollToBottom()}),100)):w.Am.success("새 메시지가 도착했습니다.",{onClick:function(){var e;null===(e=n.current)||void 0===e||e.scrollToBottom()},closeOnClick:!0}))}))}),[h,S,A]);if((0,r.useEffect)((function(){return null==I||I.on("dm",D),function(){null==I||I.off("dm",D)}}),[I,D]),(0,r.useEffect)((function(){var e;1===(null==C?void 0:C.length)&&(null===(e=n.current)||void 0===e||e.scrollToBottom())}),[C]),!S||!Z)return null;var H=(0,g.Z)(C?C.flat().reverse():[]);return r.createElement(o,null,r.createElement(a,null,r.createElement("img",{src:i().url(Z.email,{s:"24px",d:"retro"}),alt:Z.nickname}),r.createElement("span",null,Z.nickname)),r.createElement(m.Z,{chatSections:H,scrollbarRef:n,setSize:T,isEmpty:_,isReachingEnd:B}),r.createElement(d.Z,{chat:z,onChangeChat:O,onSubmitForm:j,placeholder:"채팅입력"}))}}}]);